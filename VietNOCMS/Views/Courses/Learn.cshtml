@model VietNOCMS.Models.LearningWatchViewModel
@{
    Layout = null;
    string GetEmbedUrl(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        if (url.Contains("/embed/")) return url;
        string videoId = "";
        if (url.Contains("v="))
        {
            var parts = url.Split(new string[] { "v=" }, StringSplitOptions.None);
            if (parts.Length > 1) videoId = parts[1].Split('&')[0];
        }
        else if (url.Contains("youtu.be/")) { videoId = url.Split('/').Last().Split('?')[0]; }
        return !string.IsNullOrEmpty(videoId) ? $"https://www.youtube.com/embed/{videoId}?autoplay=1" : url;
    }
    int totalLessons = Model.Course.Chapters.Sum(c => c.Lessons.Count);
    int completedCount = Model.CompletedLessonIds.Count;
    int percent = totalLessons > 0 ? (int)((double)completedCount / totalLessons * 100) : 0;

    string type = (Model.CurrentLesson.LessonType ?? "").Trim().ToLower();
    bool isAssignment = type == "assignment";
    bool isMeeting = type == "meeting" || type == "stream";
    bool hasVideo = !string.IsNullOrEmpty(Model.CurrentLesson.VideoUrl);
    bool hasDoc = !string.IsNullOrEmpty(Model.CurrentLesson.DocumentUrl);
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.CurrentLesson.LessonName - @Model.Course.CourseName</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-color: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f0f9ff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            color: white;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
        }

        .back-btn {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: 0.3s;
        }

            .back-btn:hover {
                background: rgba(255,255,255,0.15);
                color: white;
            }

        .course-name {
            font-weight: 600;
            font-size: 16px;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-bar-custom {
            width: 160px;
            height: 8px;
            background: rgba(255,255,255,0.25);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #22c55e;
            width: @percent %;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .content-column {
            flex: 1;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
        }

        .stage-wrapper {
            width: 100%;
            background: #000;
            /* Thay đổi quan trọng nhất ở đây */
            /* Chiều cao = 100% màn hình - (chiều cao Header 70px) - (khoảng hở dưới đáy 20px) */
            height: calc(100vh - 90px);
            min-height: 500px; /* Đảm bảo không quá bé trên màn hình nhỏ */
            flex-shrink: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Playlist Column */
        .playlist-column {
            width: 380px;
            background: white;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .playlist-items {
            flex: 1;
            overflow-y: auto;
        }

        .lesson-item {
            padding: 14px 20px;
            display: flex;
            gap: 12px;
            text-decoration: none;
            color: #475569;
            border-bottom: 1px solid #f1f5f9;
            align-items: flex-start;
            transition: 0.2s;
        }

            .lesson-item:hover {
                background: #f8fafc;
                color: var(--primary-color);
            }

            .lesson-item.active {
                background: #eff6ff;
                border-left: 4px solid var(--primary-color);
                color: var(--primary-color);
            }

            .lesson-item.completed .status-icon {
                background: var(--success);
                border-color: var(--success);
            }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            margin-top: 2px;
        }

        .lesson-content {
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            background: white;
            min-height: 100%;
        }

        .btn-nav {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: white;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

            .btn-nav.success {
                background: var(--success);
                color: white;
                border: none;
            }

        /* AI Panels */
        .ai-panel {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* AI Review Popup (Assignment) */
        .ai-review-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 400px;
            max-height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 999;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.3s ease;
        }

        .ai-review-header {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            padding: 15px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 16px 16px 0 0;
        }

        .ai-review-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 200px;
            max-height: 50vh;
        }

        .ai-review-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }

        /* Assignment Specific */
        .assignment-view {
            background: #fff;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .assignment-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 40px 30px;
            color: white;
        }

        .assignment-body {
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .assignment-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .assignment-card-header {
            background: #f8fafc;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }

        .assignment-card-body {
            padding: 24px;
        }

        @@keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @@media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                overflow-y: auto;
            }

            .stage-wrapper {
                height: auto;
                aspect-ratio: 16/9;
                min-height: auto;
            }

            .playlist-column {
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid #e2e8f0;
            }

            .ai-review-panel {
                width: 90%;
                left: 5%;
                right: 5%;
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()

    <div class="header">
        <a href="@Url.Action("MyCourses", "Student")" class="back-btn"><i class="fas fa-arrow-left"></i> Quay lại</a>
        <div class="course-info">
            <div class="course-name">@Model.Course.CourseName</div>
            <div style="display:flex; align-items:center; gap:10px; font-size:13px; color:rgba(255,255,255,0.8);">
                <div class="progress-bar-custom"><div class="progress-fill"></div></div>
                <span>@completedCount/@totalLessons bài</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-column">
            <div class="stage-wrapper">
                @if (isAssignment)
                {
                    <div class="assignment-view">
                        <div class="assignment-header">
                            <div class="text-center">
                                <div style="width:60px; height:60px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px;">
                                    <i class="bi bi-pencil-square fs-2"></i>
                                </div>
                                <h2 class="fw-bold mb-2">@Model.CurrentLesson.LessonName</h2>
                                @if (Model.CurrentLesson.DueDate.HasValue)
                                {
                                    <span class="badge bg-white text-primary rounded-pill px-3 py-2">
                                        <i class="bi bi-clock-history"></i> Hạn nộp: @Model.CurrentLesson.DueDate.Value.ToString("HH:mm dd/MM/yyyy")
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="assignment-body">
                            <div class="assignment-card">
                                <div class="assignment-card-header">
                                    <span><i class="bi bi-file-text text-primary me-2"></i> Nội dung đề bài</span>
                                </div>
                                <div class="assignment-card-body">
                                    @if (!string.IsNullOrEmpty(Model.CurrentLesson.Content))
                                    {
                                        <div style="line-height: 1.8;">@Html.Raw(Model.CurrentLesson.Content)</div>
                                    }
                                    else
                                    {
                                        <p class="text-muted fst-italic">Không có mô tả chi tiết.</p>
                                    }

                                    @if (!string.IsNullOrEmpty(Model.CurrentLesson.DocumentUrl))
                                    {
                                        <div class="mt-3 pt-3 border-top">
                                            <a href="@Url.Content(Model.CurrentLesson.DocumentUrl)" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-download me-1"></i> Tải tài liệu đính kèm
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="assignment-card">
                                <div class="assignment-card-header">
                                    <span><i class="bi bi-send text-success me-2"></i> Nộp bài làm</span>
                                    <button type="button" class="btn btn-sm text-white shadow-sm" onclick="toggleAIReview()"
                                            style="background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 20px;">
                                        <i class="bi bi-stars me-1"></i> AI Chấm thử
                                    </button>
                                </div>
                                <div class="assignment-card-body">
                                    <form id="submissionForm">
                                        <input type="hidden" name="lessonId" value="@Model.CurrentLesson.LessonId" />
                                        <div class="mb-3">
                                            <label class="form-label fw-medium">Nội dung bài làm</label>
                                            <textarea id="submissionContent" name="submissionContent" class="form-control" rows="6" placeholder="Nhập nội dung hoặc link bài làm..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-medium">Đính kèm file (tùy chọn)</label>
                                            <input class="form-control" type="file" name="submissionFile" id="inputGroupFile">
                                            <small class="text-muted">Hỗ trợ: PDF, DOC, DOCX, JPG, PNG (Max 10MB)</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success px-4"><i class="bi bi-upload me-2"></i>Nộp bài</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('submissionForm').reset()"><i class="bi bi-arrow-clockwise"></i></button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div style="height:50px"></div>
                        </div>
                    </div>

                    <div class="ai-review-panel" id="aiReviewPanel">
                        <div class="ai-review-header">
                            <div>
                                <h6 class="mb-0 fw-bold"><i class="bi bi-robot me-2"></i>AI Chấm Thử</h6>
                            </div>
                            <button onclick="toggleAIReview()" style="background:none; border:none; color:white; font-size:20px;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="ai-review-body" id="aiReviewContent">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-lightbulb fs-1 opacity-25"></i>
                                <p class="mt-3 mb-0">Gửi bài làm để AI đánh giá sơ bộ</p>
                            </div>
                        </div>
                        <div class="ai-review-input-area">
                            <textarea id="aiTextInput" class="form-control mb-2" rows="3" placeholder="Nhập nội dung cần chấm..."></textarea>
                            <div class="d-flex gap-2">
                                <input type="file" id="aiFileInput" style="display:none;" accept=".pdf,.doc,.docx,.txt">
                                <button class="btn btn-light border" onclick="document.getElementById('aiFileInput').click()" title="Đính file">
                                    <i class="bi bi-paperclip text-secondary"></i>
                                </button>
                                <button class="btn btn-primary flex-grow-1" onclick="req_SubmitAIReview()">
                                    <i class="bi bi-send-fill me-2"></i>Gửi chấm
                                </button>
                            </div>
                            <div id="aiFileSelected" class="small text-primary mt-1"></div>
                        </div>
                    </div>
                }
                else if (isMeeting)
                {
                    <div class="h-100 w-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">
                        <div class="text-center text-white p-4">
                            <i class="bi bi-camera-video-fill display-1 mb-3"></i>
                            <h2 class="fw-bold mb-3">Lớp học trực tuyến</h2>
                            @if (Model.CurrentLesson.StartTime.HasValue)
        {
            <p class="fs-5 mb-4 text-white-50">
                <i class="bi bi-calendar-event me-2"></i>
                Bắt đầu lúc: <strong>@Model.CurrentLesson.StartTime.Value.ToString("HH:mm 'ngày' dd/MM/yyyy")</strong>
                                  
            </p>
        }
                           
                            @if (!string.IsNullOrEmpty(Model.CurrentLesson.MeetingLink))
                            {
                                <a href="@Model.CurrentLesson.MeetingLink" target="_blank" class="btn btn-light btn-lg rounded-pill px-5 fw-bold">Tham gia ngay</a>
                            }
                            else
                            {
                                <div class="alert alert-danger bg-opacity-75 text-white border-0">Chưa có link phòng học</div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div id="view-video" class="w-100 h-100 bg-black d-flex align-items-center justify-content-center">
                        @if (hasVideo)
                        {
                            if (Model.CurrentLesson.VideoUrl.Contains("youtube") || Model.CurrentLesson.VideoUrl.Contains("youtu.be"))
                            {
                                <iframe width="100%" height="100%" src="@GetEmbedUrl(Model.CurrentLesson.VideoUrl)" frameborder="0" allowfullscreen></iframe>
                            }
                            else
                            {
                                <video controls width="100%" height="100%" style="background:black;"><source src="@Url.Content(Model.CurrentLesson.VideoUrl)" type="video/mp4"></video>
                            }
                        }
                        else
                        {
                            <div class="text-center text-secondary"><i class="bi bi-play-btn-fill display-1 opacity-25"></i><p class="mt-3">Không có video</p></div>
                        }
                    </div>
                }
            </div>

            <div class="lesson-content">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                    <h2 class="h4 fw-bold mb-0">@Model.CurrentLesson.LessonName</h2>
                    @if (Model.CompletedLessonIds.Contains(Model.CurrentLesson.LessonId))
                    {
                        <button class="btn-nav success" disabled><i class="fas fa-check-circle"></i> Đã hoàn thành</button>
                    }
                    else
                    {
                        <button class="btn-nav success" onclick="markDone(@Model.CurrentLesson.LessonId)"><i class="far fa-circle"></i> Đánh dấu xong</button>
                    }
                </div>

                <div class="d-flex justify-content-between mb-4">
                    @{
                        var all = Model.Course.Chapters.SelectMany(c => c.Lessons).ToList();
                        var idx = all.FindIndex(l => l.LessonId == Model.CurrentLesson.LessonId);
                    }
                    @if (idx > 0)
                    {
                        <a href="@Url.Action("Learn", new { id = Model.Course.CourseId, lessonId = all[idx - 1].LessonId })" class="btn-nav"><i class="fas fa-arrow-left"></i> Bài trước</a>
                    }
                    else
                    {

                        <div></div>
                    }
                    @if (idx < all.Count - 1)
                    {
                        <a href="@Url.Action("Learn", new { id = Model.Course.CourseId, lessonId = all[idx + 1].LessonId })" class="btn-nav">Bài tiếp theo <i class="fas fa-arrow-right"></i></a>
                    }
                </div>

                @if (!isAssignment && !string.IsNullOrEmpty(Model.CurrentLesson.Content))
                {
                    <div class="text-secondary" style="line-height:1.8">@Html.Raw(Model.CurrentLesson.Content)</div>
                }
                @if (!isAssignment && hasDoc)
                {
                    <div class="alert alert-light d-flex justify-content-between align-items-center mt-3 border">
                        <span><i class="fas fa-paperclip me-2"></i> Tài liệu đính kèm</span>
                        <a href="@Model.CurrentLesson.DocumentUrl" target="_blank" class="btn-nav"><i class="fas fa-download"></i> Tải về</a>
                    </div>
                }
            </div>
        </div>

        <div class="playlist-column">
            <div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
                <span class="fw-bold">Nội dung khóa học</span>
                <button onclick="toggleAI()" class="btn btn-sm btn-primary"><i class="bi bi-robot"></i> AI</button>
            </div>

            <div class="ai-panel">
                <ul class="nav nav-pills nav-justified mb-3 p-1 bg-light rounded">
                    <li class="nav-item"><button class="nav-link active btn-sm fw-bold" data-bs-toggle="tab" data-bs-target="#tab-ai-chat"><i class="bi bi-chat-dots me-1"></i> Hỏi bài</button></li>
                    <li class="nav-item"><button class="nav-link btn-sm fw-bold" data-bs-toggle="tab" data-bs-target="#tab-ai-sum"><i class="bi bi-file-text me-1"></i> Tóm tắt</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-ai-chat">
                        <div id="aiChatBox" class="border rounded bg-white p-3 mb-2" style="height: 350px; overflow-y: auto;">
                            <div class="text-center text-muted mt-5"><i class="bi bi-robot fs-1"></i><p class="small mt-2">Chào bạn! Tôi là trợ lý AI.<br>Hãy hỏi tôi về bài học này.</p></div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="aiChatInput" class="form-control" placeholder="Nhập câu hỏi...">
                            <button class="btn btn-primary" type="button" onclick="req_AskAI()"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab-ai-sum">
                        @if (hasDoc)
                        {
                            <div class="d-grid mb-3"><button class="btn btn-outline-primary btn-sm fw-bold" onclick="req_SummarizeDoc()"><i class="bi bi-magic me-2"></i> Tóm tắt tài liệu bài học</button></div>
                            <div class="text-center text-muted small mb-3">- HOẶC -</div>
                        }
                        <div class="card bg-light border-0 p-3 mb-3">
                            <label class="form-label small fw-bold">Upload file (PDF/DOCX)</label>
                            <div class="input-group input-group-sm mb-2"><input type="file" class="form-control" id="aiUploadInput"></div>
                            <button class="btn btn-success btn-sm w-100 fw-bold" onclick="req_SummarizeUpload()"><i class="bi bi-cloud-upload me-2"></i> Tóm tắt file này</button>
                        </div>
                        <div id="aiSummaryResult" class="border rounded bg-white p-3 d-none" style="max-height: 300px; overflow-y: auto; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </div>

            <div class="playlist-items">
                @foreach (var chapter in Model.Course.Chapters)
                {
                    bool expand = chapter.Lessons.Any(l => l.LessonId == Model.CurrentLesson.LessonId);
                    <div class="border-bottom">
                        <div class="p-3 bg-light fw-bold d-flex justify-content-between cursor-pointer" onclick="this.nextElementSibling.classList.toggle('d-none'); this.querySelector('i').classList.toggle('fa-rotate-180')">
                            <span>@chapter.ChapterName</span><i class="fas fa-chevron-down @(expand ? "" : "fa-rotate-180")"></i>
                        </div>
                        <div class="@(expand ? "" : "d-none")">
                            @foreach (var l in chapter.Lessons)
                            {
                                string lType = (l.LessonType ?? "").Trim().ToLower();
                                bool isAss = lType == "assignment"; bool isMeet = lType == "meeting";
                                string active = l.LessonId == Model.CurrentLesson.LessonId ? "active" : "";
                                <a href="@Url.Action("Learn", new { id = Model.Course.CourseId, lessonId = l.LessonId })" class="lesson-item @active @(Model.CompletedLessonIds.Contains(l.LessonId) ? "completed" : "")">
                                    <div class="status-icon">@if (Model.CompletedLessonIds.Contains(l.LessonId)) {
                                    <i class="fas fa-check"></i>
                                }
    </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium" style="font-size:14px">@l.LessonName</div>
                                    <div class="small mt-1 d-flex align-items-center">
                                        @if (isAss)
                                        {
                                            <span class="badge bg-warning text-dark border border-warning"><i class="bi bi-pencil-square me-1"></i>BÀI TẬP</span>
                                        }
                                        else if (isMeet)
                                        {

                                            <span class="badge bg-danger"><i class="bi bi-camera-video me-1"></i>LIVE</span>
                                        }
                                        else
                                        {

                                            <span class="text-muted"><i class="bi bi-play-circle me-1"></i>@l.DurationInMinutes phút</span>
                                        }
                                    </div>
                                </div>
                            </a>
                        }
                    </div>
                </div>
                                }
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. CONFIG & UTILS ---
        const _ai_LessonId = @Model.CurrentLesson.LessonId;
        const _ai_TokenField = document.querySelector('input[name="__RequestVerificationToken"]');
        const _ai_Token = _ai_TokenField ? _ai_TokenField.value : "";
        const _enrollId = '@Model.EnrollmentId';

        function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }

        // --- 2. AI CHAT ---
        window.req_AskAI = function() {
            const input = document.getElementById('aiChatInput');
            const box = document.getElementById('aiChatBox');
            if (!input || !box || !input.value.trim()) return;

            const msg = input.value.trim();
            box.innerHTML += `<div class="d-flex justify-content-end mb-2"><div class="bg-primary text-white px-3 py-2 rounded-3 small" style="max-width:85%">${escapeHtml(msg)}</div></div>`;
            input.value = '';

            const loadId = 'load-' + Date.now();
            box.innerHTML += `<div id="${loadId}" class="mb-2 text-muted small"><i class="fas fa-circle-notch fa-spin me-1"></i> AI đang viết...</div>`;
            box.scrollTop = box.scrollHeight;

            $.post('/AiStudent/AskTutor', { lessonId: _ai_LessonId, question: msg, __RequestVerificationToken: _ai_Token }, function (res) {
                document.getElementById(loadId)?.remove();
                if (res.success) {
                    box.innerHTML += `<div class="d-flex justify-content-start mb-3"><div class="bg-light border px-3 py-2 rounded-3 small text-dark" style="max-width:90%"><strong><i class="bi bi-robot"></i> Tutor:</strong><br>${res.answer.replace(/\n/g, '<br>')}</div></div>`;
                } else {
                    box.innerHTML += `<div class="text-danger small mb-2">Lỗi: ${res.message}</div>`;
                }
                box.scrollTop = box.scrollHeight;
            }).fail(function() {
                document.getElementById(loadId)?.remove();
                box.innerHTML += `<div class="text-danger small mb-2">Lỗi kết nối.</div>`;
            });
        };

        document.getElementById('aiChatInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') req_AskAI(); });

        // --- 3. AI TÓM TẮT ---
        window.req_SummarizeDoc = function() {
            const resBox = document.getElementById('aiSummaryResult');
            resBox.classList.remove('d-none');
            resBox.innerHTML = '<div class="text-center py-3 text-primary"><i class="fas fa-circle-notch fa-spin"></i> Đang đọc tài liệu...</div>';
            $.post('/AiStudent/SummarizeCurrentDocument', { lessonId: _ai_LessonId, __RequestVerificationToken: _ai_Token }, function (res) {
                if (res.success) resBox.innerHTML = `<div class="text-success fw-bold mb-2">Kết quả:</div><div>${res.summary}</div>`;
                else resBox.innerHTML = `<div class="text-danger small">${res.message}</div>`;
            }).fail(() => resBox.innerHTML = `<div class="text-danger small">Lỗi kết nối.</div>`);
        };

        window.req_SummarizeUpload = function() {
            const fileInput = document.getElementById('aiUploadInput');
            if (fileInput.files.length === 0) { alert("Chọn file trước!"); return; }
            const resBox = document.getElementById('aiSummaryResult');
            resBox.classList.remove('d-none');
            resBox.innerHTML = '<div class="text-center py-3 text-primary"><i class="fas fa-circle-notch fa-spin"></i> Đang phân tích...</div>';

            var fd = new FormData(); fd.append('file', fileInput.files[0]); fd.append('__RequestVerificationToken', _ai_Token);
            $.ajax({ url: '/AiStudent/SummarizeUploadedFile', type: 'POST', data: fd, processData: false, contentType: false,
                success: res => {
                    if (res.success) resBox.innerHTML = `<div class="text-success fw-bold mb-2">Kết quả:</div><div>${res.summary}</div>`;
                    else resBox.innerHTML = `<div class="text-danger small">${res.message}</div>`;
                },
                error: () => resBox.innerHTML = `<div class="text-danger small">Lỗi kết nối.</div>`
            });
        };

        // --- 4. NỘP BÀI & CHẤM THỬ ---
        window.toggleAIReview = function() {
            const p = document.getElementById('aiReviewPanel');
            if(p) {
                if(p.style.display==='none' || !p.style.display) {
                    p.style.display='flex';
                    const mainVal = document.getElementById('submissionContent').value;
                    const aiVal = document.getElementById('aiTextInput');
                    if(mainVal && !aiVal.value) aiVal.value = mainVal;
                } else p.style.display='none';
            }
        };

        window.req_SubmitAIReview = function() {
            const text = document.getElementById('aiTextInput').value;
            const fileInput = document.getElementById('aiFileInput');
            const file = fileInput?.files.length > 0 ? fileInput.files[0] : null;
            if (!text.trim() && !file) { Swal.fire('Thông báo', 'Nhập nội dung!', 'warning'); return; }

            const resBox = document.getElementById('aiReviewContent');
            resBox.innerHTML = `<div class="text-center py-5 text-primary"><i class="fas fa-circle-notch fa-spin"></i> AI đang chấm...</div>`;

            var fd = new FormData(); fd.append('lessonId', _ai_LessonId); fd.append('submission', text); fd.append('__RequestVerificationToken', _ai_Token);
            if(file) fd.append('file', file);

            $.ajax({ url: '/AiStudent/ReviewAssignment', type: 'POST', data: fd, processData: false, contentType: false,
                success: res => {
                    if (res.success) {
                        resBox.innerHTML = `<div class="p-3 bg-white border rounded shadow-sm"><h6 class="text-success fw-bold">Đánh giá:</h6>${res.review}</div><div class="text-center mt-2"><button class="btn btn-sm btn-light border" onclick="resetAiReview()">Reset</button></div>`;
                    } else resBox.innerHTML = `<div class="alert alert-danger m-3">${res.message}</div>`;
                },
                error: () => resBox.innerHTML = `<div class="alert alert-danger m-3">Lỗi kết nối.</div>`
            });
        };

        window.resetAiReview = function() {
            document.getElementById('aiReviewContent').innerHTML = `<div class="text-center text-muted py-4"><i class="bi bi-lightbulb fs-1 opacity-25"></i><p class="mt-3 mb-0">Gửi bài làm để chấm thử</p></div>`;
        };

        // File name display in AI Review
        document.getElementById('aiFileInput')?.addEventListener('change', function() {
            document.getElementById('aiFileSelected').innerText = this.files[0] ? 'Đã chọn: ' + this.files[0].name : '';
        });

        // --- 5. CORE FUNCTIONS ---
        function toggleAI() { $('.ai-panel').slideToggle(); }
        function markDone(id) { $.post('/Courses/MarkAsCompleted', { lessonId: id, enrollmentId: _enrollId, __RequestVerificationToken: _ai_Token }, function (res) { if (res.success) location.reload(); }); }

        const subForm = document.getElementById('submissionForm');
        if (subForm) {
            subForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const content = document.getElementById('submissionContent').value;
                const f = document.getElementById('inputGroupFile').files[0];
                if (!content.trim() && !f) { Swal.fire('Lỗi', 'Nhập nội dung hoặc file!', 'warning'); return; }

                var fd = new FormData(this);
                if(!fd.has('__RequestVerificationToken')) fd.append('__RequestVerificationToken', _ai_Token);

                Swal.fire({ title: 'Đang nộp...', didOpen: () => Swal.showLoading() });
                $.ajax({ url: '/Courses/SubmitAssignment', type: 'POST', data: fd, processData: false, contentType: false,
                    success: res => {
                        if (res.success) Swal.fire('Thành công', 'Đã nộp bài!', 'success').then(() => location.reload());
                        else Swal.fire('Lỗi', res.message, 'error');
                    },
                    error: () => Swal.fire('Lỗi', 'Lỗi kết nối server', 'error')
                });
            });
        }
    </script>
</body>
</html>