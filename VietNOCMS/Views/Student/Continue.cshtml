@model VietNOCMS.Models.ContinueLearningViewModel

@{
    ViewData["Title"] = "Tiếp tục học";
}

@section Styles {
    <style>
        .continue-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 0;
            margin-top: 0px;
            color: white;
        }

        .quick-resume-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-top: -3rem;
            position: relative;
            z-index: 10;
        }

        .resume-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem; /* Thêm khoảng cách nếu có nhiều thẻ */
        }

            .resume-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 50px rgba(102, 126, 234, 0.3);
            }

        .resume-thumbnail {
            width: 200px;
            height: 120px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            flex-shrink: 0;
        }

        .resume-info {
            flex: 1;
        }

        .resume-course-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .resume-lesson-name {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .resume-progress {
            background: rgba(255, 255, 255, 0.2);
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .resume-progress-bar {
            background: white;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .resume-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .resume-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .btn-resume {
            background: white;
            color: #667eea;
            padding: 1rem 2rem;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

            .btn-resume:hover {
                transform: scale(1.05);
                box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
            }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .recent-lesson-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

            .recent-lesson-card:hover {
                transform: translateX(10px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            }

        .lesson-thumbnail {
            width: 120px;
            height: 80px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            flex-shrink: 0;
            position: relative;
        }

        .lesson-duration {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-course {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .lesson-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .lesson-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .lesson-action {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .lesson-progress-mini {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .progress-circle {
            transform: rotate(-90deg);
        }

        .progress-circle-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 4;
        }

        .progress-circle-bar {
            fill: none;
            stroke: url(#gradient);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            color: #667eea; /* primary color */
            font-size: 0.875rem;
        }

        .schedule-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .schedule-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

            .schedule-item:hover {
                background: #f8fafc;
            }

        .schedule-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea, #764ba2); /* fallback */
            color: white;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
        }

        .schedule-day {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .schedule-hour {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .schedule-details {
            flex: 1;
        }

        .schedule-course {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .schedule-lesson {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .goal-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            text-align: center;
        }

        .goal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .goal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .goal-progress {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0;
        }

        .goal-target {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        @@media (max-width: 768px) {
            .resume-card {
                flex-direction: column;
                text-align: center;
            }

            .resume-thumbnail {
                width: 100%;
            }

            .recent-lesson-card {
                flex-direction: column;
                text-align: center;
            }

            .lesson-thumbnail {
                width: 100%;
                height: 120px;
            }

            .lesson-action {
                align-items: center;
            }
        }
    </style>

    <svg width="0" height="0">
        <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#667eea" />
                <stop offset="100%" stop-color="#764ba2" />
            </linearGradient>
        </defs>
    </svg>
}

<div class="continue-header">
    <div class="container">
        <h1 class="text-center mb-2"><i class="bi bi-play-circle"></i> Tiếp tục học</h1>
        <p class="text-center mb-0 opacity-75">Học tập liên tục, tiến bộ mỗi ngày</p>
    </div>
</div>

<div class="container py-5">
    <div class="quick-resume-section mb-5">
        @if (Model.ContinueCourses != null && Model.ContinueCourses.Any())
        {
            @foreach (var course in Model.ContinueCourses)
            {
                <div class="resume-card"
                     data-course-id="@course.CourseId"
                     data-lesson-id="@course.LastLessonId">

                    <div class="resume-thumbnail">
                        <i class="bi bi-play-circle-fill"></i>
                    </div>
                    <div class="resume-info">
                        <div class="resume-course-name">@course.CourseName</div>
                        <div class="resume-lesson-name">
                            <i class="bi bi-file-play"></i> Đang học: @course.LessonName
                        </div>
                        <div class="resume-progress">
                            <div class="resume-progress-bar" style="width:@course.ProgressPercent%"></div>
                        </div>
                        <div class="resume-stats">
                            <span><i class="bi bi-clock"></i> ~@course.RemainingMinutes phút còn lại</span>
                            <span><i class="bi bi-trophy"></i> @course.ProgressPercent% hoàn thành</span>
                        </div>
                    </div>
                    <div class="resume-action">
                        <button class="btn-resume">
                            <a href="@Url.Action("Learn", "Courses", new { id = course.CourseId, lessonId = course.LastLessonId })"
                               class="btn-resume text-decoration-none d-inline-flex align-items-center justify-content-center">
                                <i class="bi bi-play-fill me-1"></i> Tiếp tục học
                        </button>
                        <small style="opacity: 0.8;">
                            <i class="bi bi-eye"></i> Truy cập lần cuối: @course.LastAccessed.ToString("HH:mm dd/MM")
                        </small>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-4">
                <h4 class="text-muted">Bạn chưa bắt đầu khóa học nào.</h4>
                <a href="@Url.Action("ExploreCourse", "Student")" class="btn btn-primary mt-2">Khám phá ngay</a>
            </div>
        }
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="section-header">
                <h2 class="section-title"><i class="bi bi-clock-history"></i> Bài học gần đây</h2>
                <a href="#" class="btn btn-outline-secondary rounded-pill">Xem tất cả</a>
            </div>

            @foreach (var lesson in Model.RecentLessons)
            {
                <div class="recent-lesson-card mb-3" style="cursor: pointer;"
                     onclick="window.location.href='@Url.Action("Learn", "Courses", new { id = lesson.CourseId, lessonId = lesson.LessonId })'">

                    <div class="lesson-thumbnail" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="bi bi-play-circle-fill"></i>
                        <span class="lesson-duration">@lesson.Duration</span>
                    </div>
                    <div class="lesson-info">
                        <div class="lesson-course">@lesson.CourseName</div>
                        <div class="lesson-title">@lesson.LessonTitle</div>
                        <div class="lesson-meta">
                            <span><i class="bi bi-calendar"></i> @lesson.LastAccessed.ToString("dd/MM")</span>
                            <span><i class="bi bi-eye"></i> Đã xem @lesson.ProgressPercent%</span>
                        </div>
                    </div>
                    <div class="lesson-action">
                        <div class="lesson-progress-mini">
                            <svg class="progress-circle" width="60" height="60" viewBox="0 0 60 60">
                                <circle class="progress-circle-bg" cx="30" cy="30" r="26"></circle>
                                <circle class="progress-circle-bar" cx="30" cy="30" r="26"
                                        stroke-dasharray="163.36"
                                        stroke-dashoffset="@(163.36 * (100 - lesson.ProgressPercent) / 100)">
                                </circle>
                            </svg>
                            <div class="progress-text">@lesson.ProgressPercent%</div>
                        </div>

                        <a asp-controller="Courses"
                           asp-action="Learn"
                           asp-route-id="@lesson.CourseId"
                           asp-route-lessonId="@lesson.LessonId"
                           class="btn btn-sm btn-primary rounded-pill px-3 text-decoration-none"
                           onclick="event.stopPropagation()">
                            <i class="bi bi-play-fill"></i> Vào học
                        </a>
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="goal-card mb-4">
                <div class="goal-icon"><i class="bi bi-trophy-fill"></i></div>
                <div class="goal-title">Mục tiêu tuần này</div>
                <div class="goal-progress">
                    @Model.WeeklyGoal.CompletedLessons<small class="fs-5">/@Model.WeeklyGoal.TargetLessons</small>
                </div>
                <div class="goal-target">bài học hoàn thành</div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px; background: rgba(255,255,255,0.3);">
                        <div class="progress-bar bg-white"
                             style="width: @(Model.WeeklyGoal.TargetLessons > 0 ? (Model.WeeklyGoal.CompletedLessons * 100 / Model.WeeklyGoal.TargetLessons) : 0)% ; border-radius: 10px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="schedule-card">
                <h3 class="mb-3 h5 fw-bold"><i class="bi bi-calendar-week"></i> Lịch học gợi ý</h3>

                @if (Model.ScheduleToday != null && Model.ScheduleToday.Any())
                {
                    @foreach (var schedule in Model.ScheduleToday)
                    {
                        <div class="schedule-item">
                            <div class="schedule-time" style="background:@schedule.Gradient">
                                <div class="schedule-day">@schedule.Day</div>
                                <div class="schedule-hour">@schedule.Hour</div>
                            </div>
                            <div class="schedule-details">
                                <div class="schedule-course">@schedule.CourseName</div>
                                <div class="schedule-lesson">@schedule.LessonTitle</div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted small">Chưa có lịch học.</p>
                }

                <div class="text-center mt-3">
                    <a href="#" class="btn btn-outline-secondary w-100 rounded-pill">
                        <i class="bi bi-calendar-plus"></i> Xem lịch đầy đủ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Xử lý sự kiện click vào Card để chuyển trang
        document.querySelectorAll('.resume-card, .recent-lesson-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Lấy ID từ data attributes
                const courseId = this.getAttribute('data-course-id');
                const lessonId = this.getAttribute('data-lesson-id');

                if (courseId && lessonId) {
                    // Chuyển hướng đến trang học
                    // Lưu ý: Đường dẫn này phải khớp với Route của LearningController
                    window.location.href = `/Learning/Learn/${courseId}?lessonId=${lessonId}`;
                } else {
                    console.warn("Missing courseId or lessonId");
                }
            });
        });
    </script>
}